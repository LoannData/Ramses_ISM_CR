subroutine output_makefile(filename)
  character(LEN=80)::filename
  character(LEN=80)::fileloc
  character(LEN=30)::format
  integer::ilun

  ilun=11

  fileloc=TRIM(filename)
  format="(A)"
  open(unit=ilun,file=fileloc,form='formatted')
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# If you have problems with this makefile, contact Romain.Teyssier@gmail.com"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# Compilation time parameters"
  write(ilun,format)"NVECTOR = 32"
  write(ilun,format)"QUADHILBERT = 16"
  write(ilun,format)"NPRE = 8"
  write(ilun,format)""
  write(ilun,format)"NDIM = 1"
  write(ilun,format)"SOLVER = mhd"
  write(ilun,format)"NIMHD=0"
  write(ilun,format)""
  write(ilun,format)"NENT = 0"
  write(ilun,format)""
  write(ilun,format)"USE_FLD=0"
  write(ilun,format)"USE_M_1=0"
  write(ilun,format)"NGRP = 0"
  write(ilun,format)""
  write(ilun,format)"NEXTINCT = 0"
  write(ilun,format)"NPSCAL = 0"
  write(ilun,format)""
  write(ilun,format)"NENER = $(NENT)+$(NGRP)"
  write(ilun,format)""
  write(ilun,format)"PATCH ="
  write(ilun,format)"GRACKLE = 0"
  write(ilun,format)"EXEC = ramses"
  write(ilun,format)""
  write(ilun,format)"MPI = 1"
  write(ilun,format)"##COMP = ""GNU"""
  write(ilun,format)"COMP = ""INTEL"""
  write(ilun,format)""
  write(ilun,format)"ifeq ($(NIMHD),1)"
  write(ilun,format)"   NPSCAL := $(NPSCAL)+4 # for internal energy + current"
  write(ilun,format)"else"
  write(ilun,format)"   NPSCAL := $(NPSCAL)+1 # for internal energy"
  write(ilun,format)"endif"
  write(ilun,format)"ifeq ($(USE_FLD),1)"
  write(ilun,format)"   NVAR=8+$(NENER)+$(NEXTINCT)+$(NPSCAL)"
  write(ilun,format)"else"
  write(ilun,format)"   NVAR=8+$(NENER)+$(NDIM)*$(NGRP)+$(NEXTINCT)+$(NPSCAL)"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"#############################################################################"
  write(ilun,format)"GITBRANCH = $(shell git rev-parse --abbrev-ref HEAD)"
  write(ilun,format)"GITHASH = $(shell git log --pretty=format:'%H' -n 1)"
  write(ilun,format)"GITREPO = $(shell git config --get remote.origin.url)"
  write(ilun,format)"BUILDDATE = $(shell date +""%D-%T"")"
  write(ilun,format)"DEFINES = -DNVECTOR=$(NVECTOR) -DNDIM=$(NDIM) -DNPRE=$(NPRE) -DNVAR=$(NVAR) -DNENER=$(NENER) \"
  write(ilun,format)"          -DSOLVER$(SOLVER) -DNGRP=$(NGRP) -DNPSCAL=$(NPSCAL) -DNIMHD=$(NIMHD) \"
  write(ilun,format)"	  -DNEXTINCT=$(NEXTINCT) #-DQUADHILBERT=$(QUADHILBERT)"
  write(ilun,format)"ifneq (,$(filter 1,$(USE_FLD) $(USE_M_1)))"
  write(ilun,format)"DEFINES += -DUSE_FLD=$(USE_FLD) -DUSE_M_1=$(USE_M_1)"
  write(ilun,format)"endif"
  write(ilun,format)"ifeq ($(GRACKLE),1)"
  write(ilun,format)"DEFINES += -Dgrackle"
  write(ilun,format)"endif"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# Fortran compiler options and directives"
  write(ilun,format)""
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# GFORTRAN"
  write(ilun,format)"ifeq ($(COMP),""GNU"")"
  write(ilun,format)"   ifeq ($(MPI),1)"
  write(ilun,format)"      F90 = mpif90"
  write(ilun,format)"   else"
  write(ilun,format)"      F90 = gfortran"
  write(ilun,format)"      FFLAGS = -DWITHOUTMPI"
  write(ilun,format)"   endif"
  write(ilun,format)"   FFLAGS += -x f95-cpp-input -O3 -frecord-marker=4 -ffree-line-length-none $(DEFINES) #-freal-4-real-8 "
  write(ilun,format)"#   FFLAGS += -fbounds-check -fbacktrace -Wuninitialized -Wall"
  write(ilun,format)"#   FFLAGS += -ffpe-trap=invalid,zero,overflow,underflow -finit-real=nan"
  write(ilun,format)"#   FFLAGS += -finit-real=nan"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# INTEL"
  write(ilun,format)"ifeq ($(COMP),""INTEL"")"
  write(ilun,format)"   ifeq ($(MPI),1)"
  write(ilun,format)"      F90 = mpif90"
  write(ilun,format)"      FFLAGS = -cpp -fast $(DEFINES) -DNOSYSTEM"
  write(ilun,format)"   else"
  write(ilun,format)"      F90 = ifort"
  write(ilun,format)"      FFLAGS = -cpp $(DEFINES) -DWITHOUTMPI"
  write(ilun,format)"   endif"
  write(ilun,format)"   FFLAGS += -O3"
  write(ilun,format)"#   FFLAGS += -warn all -O0 -g -traceback -fpe0 -ftrapuv -check bounds"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# INTEL"
  write(ilun,format)"ifeq ($(COMP),""FTN"")"
  write(ilun,format)"   F90 = ftn"
  write(ilun,format)"   FFLAGS = -xAVX -g -traceback -fpp -fast $(DEFINES) -DNOSYSTEM #-DRT"
  write(ilun,format)"#   FFLAGS = -O3 -g -traceback -fpe0 -ftrapuv -cpp $(DEFINES) -DNOSYSTEM #-DRT"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# PGF90"
  write(ilun,format)"ifeq ($(COMP),""PGF90"")"
  write(ilun,format)"   ifeq ($(MPI),1)"
  write(ilun,format)"      F90 = mpif90"
  write(ilun,format)"      FFLAGS = -O3 -Mpreprocess $(DEFINES)"
  write(ilun,format)"   else"
  write(ilun,format)"      F90 = pgf90"
  write(ilun,format)"      FFLAGS = -Mpreprocess $(DEFINES) -DWITHOUTMPI"
  write(ilun,format)"   endif"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# TAU"
  write(ilun,format)"ifeq ($(COMP),""TAU"")"
  write(ilun,format)"   F90 = tau_f90.sh"
  write(ilun,format)"   FFLAGS = -optKeepFiles -optPreProcess -optCPPOpts=$(DEFINES) -DWITHOUTMPI"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# XLF"
  write(ilun,format)"ifeq ($(COMP),""XLF"")"
  write(ilun,format)"   F90 = xlf"
  write(ilun,format)"   FFLAGS = -WF,-DNDIM=$(NDIM),-DNPRE=$(NPRE),-DNVAR=$(NVAR),-DSOLVER$(SOLVER),-DWITHOUTMPI -qfree=f90 -qsuffix=f=f90 -qsuffix=cpp=f90"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"# F90"
  write(ilun,format)"ifeq ($(COMP),""F90"")"
  write(ilun,format)"   F90 = f90"
  write(ilun,format)"   FFLAGS = -cpp $(DEFINES) -DWITHOUTMPI"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"#############################################################################"
  write(ilun,format)"MOD = mod"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# MPI librairies"
  write(ilun,format)"LIBMPI = "
  write(ilun,format)"#LIBMPI = -lfmpi -lmpi -lelan"
  write(ilun,format)""
  write(ilun,format)"# --- CUDA libraries, for Titane ---"
  write(ilun,format)"LIBCUDA = -L/opt/cuda/lib  -lm -lcuda -lcudart"
  write(ilun,format)""
  write(ilun,format)"ifeq ($(GRACKLE),1)"
  write(ilun,format)"# Add include and library install path for grackle and hdf5 here"
  write(ilun,format)"LIBS_GRACKLE = -L$(HOME)/local/lib -lgrackle -lhdf5 -lz -lgfortran -ldl"
  write(ilun,format)"LIBS_OBJ     = -I$(HOME)/local/include -DCONFIG_BFLOAT_8 -DH5_USE_16_API -fPIC"
  write(ilun,format)"endif"
  write(ilun,format)"LIBS = $(LIBMPI) $(LIBS_GRACKLE)"
  write(ilun,format)""
  write(ilun,format)"# Lapack"
  write(ilun,format)"ifeq ($(USE_M_1),1)"
  write(ilun,format)"LIBS += -llapack"
  write(ilun,format)"else"
  write(ilun,format)"ifneq ($(NGRP),$(filter $(NGRP),0 1))"
  write(ilun,format)"LIBS += -llapack"
  write(ilun,format)"endif"
  write(ilun,format)"endif"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# Sources directories are searched in this exact order"
  write(ilun,format)"BINDIR = ."
  write(ilun,format)"VPATH = $(shell [ -z $(PATCH) ] || find $(PATCH) -type d):../$(SOLVER):../fld:../nimhd:../aton:../hydro:../pm:../poisson:../amr"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"# All objects"
  write(ilun,format)"MODOBJ = amr_parameters.o amr_commons.o random.o pm_parameters.o pm_commons.o poisson_parameters.o "
  write(ilun,format)"ifeq ($(GRACKLE),1)"
  write(ilun,format)"MODOBJ += grackle_parameters.o"
  write(ilun,format)"endif"
  write(ilun,format)"MODOBJ += poisson_commons.o hydro_parameters.o hydro_commons.o cooling_module.o bisection.o sparse_mat.o \"
  write(ilun,format)"         clfind_commons.o gadgetreadfile.o write_makefile.o write_patch.o write_gitinfo.o"
  write(ilun,format)"MODOBJ += radiation_parameters.o"
  write(ilun,format)"ifeq ($(NIMHD),1)"
  write(ilun,format)"MODOBJ +=  variables_X.o"
  write(ilun,format)"endif"
  write(ilun,format)""
  write(ilun,format)"AMROBJ = read_params.o init_amr.o init_time.o init_refine.o adaptive_loop.o amr_step.o update_time.o \"
  write(ilun,format)"         output_amr.o flag_utils.o physical_boundaries.o virtual_boundaries.o refine_utils.o nbors_utils.o \"
  write(ilun,format)"         hilbert.o load_balance.o title.o sort.o cooling_fine.o units.o light_cone.o movie.o"
  write(ilun,format)"# Particle-Mesh objects"
  write(ilun,format)"PMOBJ = init_part.o output_part.o rho_fine.o synchro_fine.o move_fine.o newdt_fine.o particle_tree.o \"
  write(ilun,format)"        add_list.o remove_list.o star_formation.o sink_particle.o feedback.o clump_finder.o clump_merger.o \"
  write(ilun,format)"        flag_formation_sites.o init_sink.o output_sink.o"
  write(ilun,format)"# Poisson solver objects"
  write(ilun,format)"POISSONOBJ = init_poisson.o phi_fine_cg.o interpol_phi.o force_fine.o multigrid_coarse.o multigrid_fine_commons.o \"
  write(ilun,format)"             multigrid_fine_fine.o multigrid_fine_coarse.o gravana.o boundary_potential.o rho_ana.o output_poisson.o"
  write(ilun,format)"# Hydro objects"
  write(ilun,format)"HYDROOBJ = init_hydro.o init_flow_fine.o write_screen.o output_hydro.o courant_fine.o godunov_fine.o \"
  write(ilun,format)"           uplmde.o umuscl.o interpol_hydro.o godunov_utils.o condinit.o hydro_flag.o hydro_boundary.o \"
  write(ilun,format)"           boundana.o read_hydro_params.o synchro_hydro_fine.o \"
  write(ilun,format)"           multigroup.o m1_utils.o \"
  write(ilun,format)"           radiative_transfer_bicg.o radiation_boundary.o"
  write(ilun,format)"ifeq ($(NIMHD),1)"
  write(ilun,format)"HYDROOBJ += uplmde_sts_ohm.o uplmde_sts_ohm_dtu.o"
  write(ilun,format)"endif"
  write(ilun,format)"# Turbulence objects"
  write(ilun,format)"#MODOBJ += turb_parameters.o turb_commons.o"
  write(ilun,format)"#TURBOBJ = turb_force_utils.o read_turb_params.o init_turb.o mpi_share_turb_fields.o \"
  write(ilun,format)"#          turb_next_field.o turb_check_time.o write_turb_fields.o read_turb_fields.o \"
  write(ilun,format)"#          add_turb_forcing.o write_pymses.o libfftw3.a"
  write(ilun,format)"# Patch objects"
  write(ilun,format)"FortranFiles = $(wildcard $(addsuffix /*.f90,$(shell [ -z $(PATCH) ] || find $(PATCH)/* -type d)))"
  write(ilun,format)"PATCHOBJ = $(notdir $(patsubst %.f90, %.o, $(FortranFiles)))"
  write(ilun,format)""
  write(ilun,format)"# All objects"
  write(ilun,format)"AMRLIB = $(AMROBJ) $(HYDROOBJ) $(PMOBJ) $(POISSONOBJ) $(PATCHOBJ) # $(TURBOBJ)"
  write(ilun,format)"# ATON objects"
  write(ilun,format)"ATON_MODOBJ = timing.o radiation_commons.o rad_step.o"
  write(ilun,format)"ATON_OBJ = observe.o init_radiation.o rad_init.o rad_boundary.o rad_stars.o rad_backup.o $(BINDIR)/../aton/atonlib/libaton.a"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"all:"
  write(ilun,format)"	for file in $(MODOBJ); do unset MAKELEVEL ; $(MAKE) $$file; done"
  write(ilun,format)"	$(MAKE) ramses"
  write(ilun,format)"ramses:	$(MODOBJ) $(AMRLIB) ramses.o"
  write(ilun,format)"	$(F90) $(MODOBJ) $(AMRLIB) ramses.o -o $(EXEC)$(NDIM)d $(LIBS)"
  write(ilun,format)"	rm write_makefile.f90"
  write(ilun,format)"	rm write_patch.f90"
  write(ilun,format)"ramses_aton: $(MODOBJ) $(ATON_MODOBJ) $(AMRLIB) $(ATON_OBJ) ramses.o"
  write(ilun,format)"	$(F90) $(MODOBJ) $(ATON_MODOBJ) $(AMRLIB) $(ATON_OBJ) ramses.o -o $(EXEC)$(NDIM)d $(LIBS) $(LIBCUDA)"
  write(ilun,format)"	rm write_makefile.f90"
  write(ilun,format)"	rm write_patch.f90"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"write_gitinfo.o: FORCE"
  write(ilun,format)"	$(F90) $(FFLAGS) -DPATCH=\'$(PATCH)\' -DGITBRANCH=\'$(GITBRANCH)\' -DGITHASH=\'""$(GITHASH)""\' \"
  write(ilun,format)" -DGITREPO=\'$(GITREPO)\' -DBUILDDATE=\'""$(BUILDDATE)""\' -c $(BINDIR)/../amr/write_gitinfo.f90 -o $@		"
  write(ilun,format)"write_makefile.o: FORCE"
  write(ilun,format)"	$(BINDIR)/../utils/scripts/cr_write_makefile.sh $(MAKEFILE_LIST)"
  write(ilun,format)"	$(F90) $(FFLAGS) -c write_makefile.f90 -o $@"
  write(ilun,format)"write_patch.o: FORCE"
  write(ilun,format)"	$(BINDIR)/../utils/scripts/cr_write_patch.sh $(PATCH)"
  write(ilun,format)"	$(F90) $(FFLAGS) -c write_patch.f90 -o $@"
  write(ilun,format)"%.o:%.F"
  write(ilun,format)"	$(F90) $(FFLAGS) -c $^ -o $@ $(LIBS_OBJ)"
  write(ilun,format)"%.o:%.f90"
  write(ilun,format)"	$(F90) $(FFLAGS) -c $^ -o $@ $(LIBS_OBJ)"
  write(ilun,format)"FORCE:"
  write(ilun,format)"#############################################################################"
  write(ilun,format)"clean :"
  write(ilun,format)"	rm *.o *.$(MOD) *__genmod.f90"
  write(ilun,format)"#############################################################################"

  close(ilun)
end subroutine output_makefile
