subroutine output_patch(filename)
  character(LEN=80)::filename
  character(LEN=80)::fileloc
  character(LEN=30)::format
  integer::ilun

  ilun=11

  fileloc=TRIM(filename)
  format="(A)"
  open(unit=ilun,file=fileloc,form='formatted')
  write(ilun,format)"../patch/test_suite/nimhd-diffusion-ohm/condinit.f90"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"subroutine condinit(x,u,dx,nn)"
  write(ilun,format)"  use amr_parameters"
  write(ilun,format)"  use hydro_parameters"
  write(ilun,format)"  implicit none"
  write(ilun,format)"  integer ::nn                            ! Number of cells"
  write(ilun,format)"  real(dp)::dx                            ! Cell size"
  write(ilun,format)"  real(dp),dimension(1:nvector,1:nvar+3)::u ! Conservative variables"
  write(ilun,format)"  real(dp),dimension(1:nvector,1:ndim)::x ! Cell center position."
  write(ilun,format)"  !================================================================"
  write(ilun,format)"  ! This routine generates initial conditions for RAMSES."
  write(ilun,format)"  ! Positions are in user units:"
  write(ilun,format)"  ! x(i,1:3) are in [0,boxlen]**ndim."
  write(ilun,format)"  ! U is the conservative variable vector. Conventions are here:"
  write(ilun,format)"  ! U(i,1): d, U(i,2:4): d.u,d.v,d.w, U(i,5): E, U(i,6:8): Bleft, "
  write(ilun,format)"  ! U(i,nvar+1:nvar+3): Bright"
  write(ilun,format)"  ! Q is the primitive variable vector. Conventions are here:"
  write(ilun,format)"  ! Q(i,1): d, Q(i,2:4):u,v,w, Q(i,5): P, Q(i,6:8): Bleft, "
  write(ilun,format)"  ! Q(i,nvar+1:nvar+3): Bright"
  write(ilun,format)"  ! If nvar > 8, remaining variables (9:nvar) are treated as passive"
  write(ilun,format)"  ! scalars in the hydro solver."
  write(ilun,format)"  ! U(:,:) and Q(:,:) are in user units."
  write(ilun,format)"  !================================================================"
  write(ilun,format)"  integer::i,ivar"
  write(ilun,format)"  real(dp),dimension(1:nvector,1:nvar+3),save::q   ! Primitive variables"
  write(ilun,format)""
  write(ilun,format)"  real(dp) :: xx,yy,zz"
  write(ilun,format)""
  write(ilun,format)"  ! Call built-in initial condition generator"
  write(ilun,format)"  call region_condinit(x,q,dx,nn)"
  write(ilun,format)"  "
  write(ilun,format)"  do i = 1,nn"
  write(ilun,format)"     xx = x(i,1) - 0.5_dp*(1.0_dp + dx)"
  write(ilun,format)"     yy = x(i,2) - 0.5_dp*(1.0_dp + dx)"
  write(ilun,format)"     zz = x(i,3) - 0.5_dp*(1.0_dp + dx)"
  write(ilun,format)"!      if((abs(xx) < 0.9_dp*dx) .and. (abs(yy) < 0.9_dp*dx) .and. (abs(zz) < 0.9_dp*dx))then"
  write(ilun,format)"     if((abs(xx) < 0.9_dp*dx) .and. (abs(zz) < 0.9_dp*dx))then"
  write(ilun,format)"!      if(abs(xx) < 0.9_dp*dx)then"
  write(ilun,format)"       q(i,     7) = 1.0_dp"
  write(ilun,format)"       q(i,nvar+2) = 1.0_dp"
  write(ilun,format)"     endif"
  write(ilun,format)"  enddo"
  write(ilun,format)"  "
  write(ilun,format)""
  write(ilun,format)"  ! Add here, if you wish, some user-defined initial conditions"
  write(ilun,format)"  ! ........"
  write(ilun,format)""
  write(ilun,format)"  ! Convert primitive to conservative variables"
  write(ilun,format)"  ! density -> density"
  write(ilun,format)"  u(1:nn,1)=q(1:nn,1)"
  write(ilun,format)"  ! velocity -> momentum"
  write(ilun,format)"  u(1:nn,2)=q(1:nn,1)*q(1:nn,2)"
  write(ilun,format)"  u(1:nn,3)=q(1:nn,1)*q(1:nn,3)"
  write(ilun,format)"  u(1:nn,4)=q(1:nn,1)*q(1:nn,4)"
  write(ilun,format)"  ! kinetic energy"
  write(ilun,format)"  u(1:nn,5)=0.0d0"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.5*q(1:nn,1)*q(1:nn,2)**2"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.5*q(1:nn,1)*q(1:nn,3)**2"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.5*q(1:nn,1)*q(1:nn,4)**2"
  write(ilun,format)"  ! pressure -> total fluid energy"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+q(1:nn,5)/(gamma-1.0d0)"
  write(ilun,format)"  ! magnetic energy -> total fluid energy"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.125d0*(q(1:nn,6)+q(1:nn,nvar+1))**2"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.125d0*(q(1:nn,7)+q(1:nn,nvar+2))**2"
  write(ilun,format)"  u(1:nn,5)=u(1:nn,5)+0.125d0*(q(1:nn,8)+q(1:nn,nvar+3))**2"
  write(ilun,format)"  u(1:nn,6:8)=q(1:nn,6:8)"
  write(ilun,format)"  u(1:nn,nvar+1:nvar+3)=q(1:nn,nvar+1:nvar+3)"
  write(ilun,format)"#if NENER>0"
  write(ilun,format)"  ! non-thermal pressure -> non-thermal energy"
  write(ilun,format)"  ! non-thermal energy   -> total fluid energy"
  write(ilun,format)"  do ivar=1,nener-ngrp"
  write(ilun,format)"     u(1:nn,8+ivar)=q(1:nn,8+ivar)/(gamma_rad(ivar)-1.0d0)"
  write(ilun,format)"     u(1:nn,5)=u(1:nn,5)+u(1:nn,8+ivar)"
  write(ilun,format)"  enddo"
  write(ilun,format)" ! Radiative transfer"
  write(ilun,format)"#if NGRP>0"
  write(ilun,format)"  ! radiative energy   -> total fluid energy"
  write(ilun,format)"  do ivar=1,ngrp"
  write(ilun,format)"     u(1:nn,firstindex_er+ivar)= q(1:nn,firstindex_er+ivar)"
  write(ilun,format)"     u(1:nn,5)=u(1:nn,5)+ u(1:nn,firstindex_er+ivar)"
  write(ilun,format)"  enddo"
  write(ilun,format)"#if USE_M_1==1"
  write(ilun,format)"  ! radiative flux"
  write(ilun,format)"  do ivar=1,ndim*ngrp"
  write(ilun,format)"     do i=1,ncache"
  write(ilun,format)"        u(1:nn,fisrtindex_fr+ivar)=q(1:nn,firstindex+ivar)"
  write(ilun,format)"     end do"
  write(ilun,format)"     write(ilun)xdp"
  write(ilun,format)"  end do"
  write(ilun,format)"#endif"
  write(ilun,format)"#endif"
  write(ilun,format)"#endif"
  write(ilun,format)"#if NEXTINCT>0"
  write(ilun,format)"  ! Extinction"
  write(ilun,format)"  if(extinction)u(1:nn,firstindex_extinct+nextinct)=1.0D0"
  write(ilun,format)"#endif"
  write(ilun,format)"#if NPSCAL>0"
  write(ilun,format)"  ! passive scalars"
  write(ilun,format)"  do ivar=1,npscal"
  write(ilun,format)"     u(1:nn,firstindex_pscal+ivar)=q(1:nn,1)*q(1:nn,firstindex_pscal+ivar)"
  write(ilun,format)"  end do"
  write(ilun,format)"  ! Internal energy"
  write(ilun,format)"  u(1:nn,nvar)=q(1:nn,5)/(gamma-1.0d0)"
  write(ilun,format)"#endif"
  write(ilun,format)""
  write(ilun,format)"end subroutine condinit"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"!================================================================"
  write(ilun,format)"subroutine velana(x,v,dx,t,ncell)"
  write(ilun,format)"  use amr_parameters"
  write(ilun,format)"  use hydro_parameters  "
  write(ilun,format)"  implicit none"
  write(ilun,format)"  integer ::ncell                         ! Size of input arrays"
  write(ilun,format)"  real(dp)::dx                            ! Cell size"
  write(ilun,format)"  real(dp)::t                             ! Current time"
  write(ilun,format)"  real(dp),dimension(1:nvector,1:3)::v    ! Velocity field"
  write(ilun,format)"  real(dp),dimension(1:nvector,1:ndim)::x ! Cell center position."
  write(ilun,format)"  !================================================================"
  write(ilun,format)"  ! This routine computes the user defined velocity fields."
  write(ilun,format)"  ! x(i,1:ndim) are cell center position in [0,boxlen] (user units)."
  write(ilun,format)"  ! v(i,1:3) is the imposed 3-velocity in user units."
  write(ilun,format)"  !================================================================"
  write(ilun,format)"  integer::i"
  write(ilun,format)"  real(dp)::xx,yy,zz,vx,vy,vz,rr,tt,omega,aa,twopi"
  write(ilun,format)""
  write(ilun,format)"  ! Add here, if you wish, some user-defined initial conditions"
  write(ilun,format)"  aa=1.0"
  write(ilun,format)"  twopi=2d0*ACOS(-1d0)"
  write(ilun,format)"  do i=1,ncell"
  write(ilun,format)""
  write(ilun,format)"!!      xx=x(i,1)"
  write(ilun,format)"!! #if NDIM > 1"
  write(ilun,format)"!!      yy=x(i,2)"
  write(ilun,format)"!! #endif"
  write(ilun,format)"!! #if NDIM > 2"
  write(ilun,format)"!!      zz=x(i,3)"
  write(ilun,format)"!! #endif"
  write(ilun,format)"!!      ! ABC"
  write(ilun,format)"!!      vx=aa*(cos(twopi*yy)+sin(twopi*zz))"
  write(ilun,format)"!!      vy=aa*(sin(twopi*xx)+cos(twopi*zz))"
  write(ilun,format)"!!      vz=aa*(cos(twopi*xx)+sin(twopi*yy))"
  write(ilun,format)""
  write(ilun,format)"!!      ! 1D advection test"
  write(ilun,format)"!!      vx=1.0_dp"
  write(ilun,format)"!!      vy=0.0_dp"
  write(ilun,format)"!!      vz=0.0_dp"
  write(ilun,format)""
  write(ilun,format)"!!      ! Ponomarenko"
  write(ilun,format)"!!      xx=xx-boxlen/2.0"
  write(ilun,format)"!!      yy=yy-boxlen/2.0"
  write(ilun,format)"!!      rr=sqrt(xx**2+yy**2)"
  write(ilun,format)"!!      if(yy>0)then"
  write(ilun,format)"!!         tt=acos(xx/rr)"
  write(ilun,format)"!!      else"
  write(ilun,format)"!!         tt=-acos(xx/rr)+twopi"
  write(ilun,format)"!!      endif"
  write(ilun,format)"!!      if(rr<1.0)then"
  write(ilun,format)"!!         omega=0.609711"
  write(ilun,format)"!!         vz=0.792624"
  write(ilun,format)"!!      else"
  write(ilun,format)"!!         omega=0.0"
  write(ilun,format)"!!         vz=0.0"
  write(ilun,format)"!!      endif"
  write(ilun,format)"!!      vx=-sin(tt)*rr*omega"
  write(ilun,format)"!!      vy=+cos(tt)*rr*omega"
  write(ilun,format)"     "
  write(ilun,format)"!!      v(i,1)=vx"
  write(ilun,format)"!! #if NDIM > 1"
  write(ilun,format)"!!      v(i,2)=vy"
  write(ilun,format)"!! #endif"
  write(ilun,format)"!! #if NDIM > 2"
  write(ilun,format)"!!      v(i,3)=vz"
  write(ilun,format)"!! #endif"
  write(ilun,format)""
  write(ilun,format)"  end do"
  write(ilun,format)""
  write(ilun,format)""
  write(ilun,format)"end subroutine velana"
  write(ilun,format)"!========================================================================================"
  write(ilun,format)"!========================================================================================"
  write(ilun,format)"!========================================================================================"
  write(ilun,format)"!========================================================================================"
  write(ilun,format)"subroutine calc_boxlen"
  write(ilun,format)""
  write(ilun,format)"  implicit none"
  write(ilun,format)""
  write(ilun,format)"  return"
  write(ilun,format)""
  write(ilun,format)"end subroutine calc_boxlen"
  write(ilun,format)""
  close(ilun)
end subroutine output_patch
